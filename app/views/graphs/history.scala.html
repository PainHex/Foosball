@(players: Seq[models.User], defaultPlayers: Seq[String], graphData: play.api.libs.json.JsValue)(implicit request: RequestHeader, flash: Flash)

@main {
  <title>Foosball - ELO History</title>
  <script type="text/javascript" src="@routes.Assets.at("javascripts/jquery.flot.min.js")"></script>
  
  <script type="text/javascript">
    var players = @Html(players.map(player => s"'${player.name}'").mkString("[", ",", "]"));
    var playerAvatars = @Html(players.map(player => s"'${player.name}':'${player.avatar}'").mkString("{", ",", "}"));
    var selectedPlayers = @Html(defaultPlayers.mkString("['", "','", "']"));
    var playerDataMap = @Html(graphData.toString);

    var flatData = $.map(playerDataMap, function(playerData) {
      return playerData;
    });

    function mainGraphLegendFormatter(label, series) {
      if ($.inArray(label, selectedPlayers) == -1) {
        return null;
      }

      return '<span class="graphLegend">' + label + '</span>';
    }

    function playerGraphLegendFormatter(label, series) {
      var avatarPath = jsRoutes.controllers.Assets.at("images/avatars/" + playerAvatars[label] + ".png").url;

      return '<img class="miniAvatar" src="' + avatarPath + '" alt="Avatar" />'
             + '<div class="playerName">' + label + '</div>';
    }

    function buildGraphOptions(legendFormatter) {
      var options = {};

      options.xaxis = {};
      options.xaxis.minTickSize = 1;
      options.xaxis.tickDecimals = 0;

      options.yaxis = {};
      options.yaxis.minTickSize = 1;
      options.yaxis.tickDecimals = 0;

      options.legend = {};
      options.legend.show = true;
      options.legend.position = "nw";

      options.legend.labelFormatter = legendFormatter;

      return options;
    }

    function setDisplayOfUnselectedPlayerData(display) {
      for (var i = 0; i < flatData.length; i++) {
        var playerData = flatData[i];

        if ($.inArray(playerData.label, selectedPlayers) == -1) {
          playerData.lines.show = display;
        }
      }
    }

    $(document).ready(function() {
      setDisplayOfUnselectedPlayerData(false);
      $.plot($("#mainGraph"), flatData, buildGraphOptions(mainGraphLegendFormatter));
      setDisplayOfUnselectedPlayerData(true);
      
      for (var i = 0; i < players.length; ++i) {
        var $playerGraph = $("#" + players[i] + "Graph");
        $.plot($playerGraph, [playerDataMap[players[i]]], buildGraphOptions(playerGraphLegendFormatter));

        $playerGraph.find(".legendColorBox").hide();
      }
    })
  </script>
}{
  <div id="mainGraph" class="centered" style="width: 1124px; height: 500px;"></div>
  
  <div class="centered">
    @for(player <- players) {
      <div style="display: inline-block; margin: 10px 0;">
	      <div id=@(player.name + "Graph") player=@(player.name) style="width: 560px; height: 200px;"></div>
      </div>
    }
  </div>
}